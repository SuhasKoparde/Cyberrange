{% extends "base.html" %}

{% block title %}Admin Panel - Cyber Range{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h2 class="mb-4">
            <i class="fas fa-cog"></i> Admin Panel
        </h2>
    </div>
</div>

<div class="row g-4 mb-4">
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <i class="fas fa-users fa-2x text-primary mb-2"></i>
                <h5 class="card-title">{{ users|length }}</h5>
                <p class="card-text">Total Users</p>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <i class="fas fa-flag fa-2x text-success mb-2"></i>
                <h5 class="card-title">{{ challenges|length }}</h5>
                <p class="card-text">Challenges</p>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <i class="fas fa-server fa-2x text-info mb-2"></i>
                <h5 class="card-title">{{ vm_status|length }}</h5>
                <p class="card-text">Virtual Machines</p>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <i class="fas fa-play fa-2x text-warning mb-2"></i>
                <h5 class="card-title">
                    {{ vm_status|selectattr("status", "equalto", "running")|list|length }}
                </h5>
                <p class="card-text">Running VMs</p>
            </div>
        </div>
    </div>
</div>

<div class="row g-4">
    <div class="col-lg-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-server"></i> VM Management
                </h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-dark table-striped">
                        <thead>
                            <tr>
                                <th>VM Name</th>
                                <th>Status</th>
                                <th>IP Address</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for vm in vm_status %}
                            <tr>
                                <td>{{ vm.name }}</td>
                                <td>
                                    <span class="badge bg-{% if vm.status == 'running' %}success{% elif vm.status == 'stopped' %}danger{% else %}warning{% endif %}">
                                        {{ vm.status|title }}
                                    </span>
                                </td>
                                <td>{{ vm.ip_address or 'N/A' }}</td>
                                <td>
                                    <div class="btn-group btn-group-sm" role="group">
                                        <button class="btn btn-success" onclick="controlVM('start', '{{ vm.name }}')">
                                            <i class="fas fa-play"></i>
                                        </button>
                                        <button class="btn btn-warning" onclick="controlVM('restart', '{{ vm.name }}')">
                                            <i class="fas fa-redo"></i>
                                        </button>
                                        <button class="btn btn-danger" onclick="controlVM('stop', '{{ vm.name }}')">
                                            <i class="fas fa-stop"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-users"></i> User Management
                </h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-dark table-striped">
                        <thead>
                            <tr>
                                <th>Username</th>
                                <th>Email</th>
                                <th>Role</th>
                                <th>Joined</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for user in users %}
                            <tr>
                                <td>{{ user.username }}</td>
                                <td>{{ user.email }}</td>
                                <td>
                                    <span class="badge bg-{% if user.role == 'admin' %}danger{% else %}primary{% endif %}">
                                        {{ user.role|title }}
                                    </span>
                                </td>
                                <td>{{ user.created_at.strftime('%Y-%m-%d') }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-flag"></i> Challenge Management
                </h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-dark table-striped">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Category</th>
                                <th>Difficulty</th>
                                <th>Points</th>
                                <th>Target IP</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for challenge in challenges %}
                            <tr>
                                <td>{{ challenge.name }}</td>
                                <td>{{ challenge.category }}</td>
                                <td>
                                    <span class="badge bg-{% if challenge.difficulty == 'Easy' %}success{% elif challenge.difficulty == 'Medium' %}warning{% else %}danger{% endif %}">
                                        {{ challenge.difficulty }}
                                    </span>
                                </td>
                                <td>{{ challenge.points }}</td>
                                <td>{{ challenge.target_ip or 'N/A' }}</td>
                                <td>
                                    <button class="btn btn-sm btn-outline-primary" onclick="editChallenge({{ challenge.id }})">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-chart-bar"></i> System Monitoring
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <div class="text-center">
                            <canvas id="adminCpuChart" width="150" height="150"></canvas>
                            <p class="mt-2 mb-0">CPU Usage</p>
                            <span id="cpuValue" class="text-muted">0%</span>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="text-center">
                            <canvas id="adminMemoryChart" width="150" height="150"></canvas>
                            <p class="mt-2 mb-0">Memory Usage</p>
                            <span id="memoryValue" class="text-muted">0%</span>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="text-center">
                            <canvas id="adminDiskChart" width="150" height="150"></canvas>
                            <p class="mt-2 mb-0">Disk Usage</p>
                            <span id="diskValue" class="text-muted">0%</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
function createAdminChart(canvasId, percentage, color) {
    const ctx = document.getElementById(canvasId).getContext('2d');
    return new Chart(ctx, {
        type: 'doughnut',
        data: {
            datasets: [{
                data: [percentage, 100 - percentage],
                backgroundColor: [color, 'rgba(255, 255, 255, 0.1)'],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            cutout: '70%',
            plugins: {
                legend: {
                    display: false
                }
            }
        }
    });
}

function controlVM(action, vmName) {
    fetch(`/vm_control/${action}/${vmName}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                location.reload();
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            alert('Error controlling VM: ' + error);
        });
}

function editChallenge(challengeId) {
    alert('Challenge editing feature coming soon!');
}

function updateAdminMetrics() {
    fetch('/system_status')
        .then(response => response.json())
        .then(data => {
            // Update charts
            if (window.adminCpuChart) {
                window.adminCpuChart.data.datasets[0].data = [data.cpu_percent, 100 - data.cpu_percent];
                window.adminCpuChart.update();
                document.getElementById('cpuValue').textContent = data.cpu_percent.toFixed(1) + '%';
            }
            if (window.adminMemoryChart) {
                window.adminMemoryChart.data.datasets[0].data = [data.memory_percent, 100 - data.memory_percent];
                window.adminMemoryChart.update();
                document.getElementById('memoryValue').textContent = data.memory_percent.toFixed(1) + '%';
            }
            if (window.adminDiskChart) {
                window.adminDiskChart.data.datasets[0].data = [data.disk_percent, 100 - data.disk_percent];
                window.adminDiskChart.update();
                document.getElementById('diskValue').textContent = data.disk_percent.toFixed(1) + '%';
            }
        })
        .catch(error => console.error('Error fetching system status:', error));
}

// Initialize admin charts
document.addEventListener('DOMContentLoaded', function() {
    window.adminCpuChart = createAdminChart('adminCpuChart', 0, '#e94560');
    window.adminMemoryChart = createAdminChart('adminMemoryChart', 0, '#0f3460');
    window.adminDiskChart = createAdminChart('adminDiskChart', 0, '#ffc107');
    
    // Initial load
    updateAdminMetrics();
    
    // Update every 3 seconds for admin
    setInterval(updateAdminMetrics, 3000);
});
</script>
{% endblock %}
