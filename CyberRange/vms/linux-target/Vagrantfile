# Linux Target VM Configuration
Vagrant.configure("2") do |config|
  config.vm.box = "ubuntu/focal64"
  config.vm.hostname = "linux-target"
  
  # Network configuration
  config.vm.network "private_network", ip: "192.168.1.30"
  
  # VM specifications
  config.vm.provider "virtualbox" do |vb|
    vb.name = "CyberRange-LinuxTarget"
    vb.memory = "1024"
    vb.cpus = 2
  end
  
  # Provisioning script
  config.vm.provision "shell", inline: <<-SHELL
    apt-get update
    apt-get install -y openssh-server vim nano curl wget
    
    # Create vulnerable users
    useradd -m -s /bin/bash user1
    echo "user1:password123" | chpasswd
    useradd -m -s /bin/bash user2
    echo "user2:admin" | chpasswd
    
    # Add user2 to sudo group (privilege escalation target)
    usermod -aG sudo user2
    
    # Create SUID binary vulnerability
    cp /bin/bash /tmp/vulnerable_binary
    chmod u+s /tmp/vulnerable_binary
    chown root:root /tmp/vulnerable_binary
    
    # Create world-writable script that runs as root
    cat > /usr/local/bin/backup.sh << 'EOF'
#!/bin/bash
# Backup script - runs as root via cron
tar -czf /tmp/backup.tar.gz /home/user1/
EOF
    chmod 777 /usr/local/bin/backup.sh
    
    # Add cron job for root
    echo "*/5 * * * * root /usr/local/bin/backup.sh" >> /etc/crontab
    
    # Install and configure SSH with weak settings
    sed -i 's/#PermitRootLogin prohibit-password/PermitRootLogin yes/' /etc/ssh/sshd_config
    sed -i 's/#PasswordAuthentication yes/PasswordAuthentication yes/' /etc/ssh/sshd_config
    systemctl restart ssh
    
    # Set weak root password
    echo "root:toor" | chpasswd
    
    # Create files with sensitive information
    echo "FLAG: CTF{root_access_gained}" > /root/flag.txt
    chmod 600 /root/flag.txt
    
    # Create .bash_history with interesting commands
    cat > /home/user1/.bash_history << 'EOF'
ls -la
cd /tmp
./vulnerable_binary
sudo -l
find / -perm -4000 2>/dev/null
cat /etc/passwd
EOF
    
    chown user1:user1 /home/user1/.bash_history
    
    echo "Linux Target VM setup complete!"
  SHELL
end
