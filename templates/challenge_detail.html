{% extends "base.html %}
{% from 'bootstrap5/form.html' import render_field %}

{% block title %}{{ challenge.name }} - Cyber Range{% endblock %}

{% block head %}
{{ super() }}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/atom-one-dark.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/bash.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/sql.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js"></script>
<script>hljs.highlightAll();</script>

<style>
    /* Fix scrolling and layout */
    html, body {
        height: 100%;
        overflow-y: auto;
    }
    
    .challenge-container {
        min-height: calc(100vh - 200px);
        padding-bottom: 2rem;
    }
    
    .challenge-content {
        line-height: 1.8;
        color: #f0f0f0;
    }
    
    .challenge-content h2, 
    .challenge-content h3, 
    .challenge-content h4 {
        margin-top: 1.5rem;
        margin-bottom: 1rem;
        color: #e94560;
    }
    
    .challenge-content pre {
        border-radius: 6px;
        margin: 1.5rem 0;
        box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        background: #1e1e2e !important;
    }
    
    .challenge-content code {
        font-family: 'Fira Code', monospace;
        font-size: 0.9em;
        background: rgba(0, 0, 0, 0.3);
        padding: 0.2em 0.4em;
        border-radius: 3px;
    }
    
    .step-badge {
        background: #e94560;
        color: white;
        padding: 0.25rem 0.75rem;
        border-radius: 15px;
        font-weight: 600;
        margin-right: 0.75rem;
    }
    
    .real-world-card {
        background: rgba(255, 255, 255, 0.05);
        border-left: 4px solid #0f3460;
    }
    
    .how-to-card {
        background: rgba(233, 69, 96, 0.05);
        border-left: 4px solid #e94560;
    }
</style>
<style>
    .challenge-content {
        line-height: 1.8;
    }
    .challenge-content h2, 
    .challenge-content h3, 
    .challenge-content h4 {
        margin-top: 1.5rem;
        margin-bottom: 1rem;
        color: #2c3e50;
    }
    .challenge-content pre {
        border-radius: 6px;
        margin: 1.5rem 0;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .challenge-content code {
        font-family: 'Fira Code', monospace;
        font-size: 0.9em;
    }
    .challenge-content table {
        width: 100%;
        margin: 1.5rem 0;
        border-collapse: collapse;
    }
    .challenge-content table {
        width: 100%;
        margin: 1.5rem 0;
        border-collapse: collapse;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        border-radius: 8px;
        overflow: hidden;
    }
    
    .challenge-content th, 
    .challenge-content td {
        padding: 0.75rem 1rem;
        border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .challenge-content thead th {
        background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
        color: white;
        font-weight: 600;
        text-transform: uppercase;
        font-size: 0.85rem;
        letter-spacing: 0.5px;
    }
    
    .challenge-content tbody tr:nth-child(odd) {
        background-color: rgba(255, 255, 255, 0.1);
    }
    
    .challenge-content tbody tr:nth-child(even) {
        background-color: rgba(0, 0, 0, 0.2);
    }
    
    .challenge-content tbody tr:hover {
        background-color: rgba(52, 152, 219, 0.25);
        transition: all 0.2s ease;
    }
    
    /* Improved text contrast */
    .challenge-content td {
        color: #f0f0f0;
    }
    
    .challenge-content th {
        color: #ffffff;
        text-shadow: 0 1px 1px rgba(0, 0, 0, 0.3);
    }
    
    /* Make code blocks more visible */
    .challenge-content code {
        background-color: rgba(0, 0, 0, 0.3);
        color: #f8f9fa;
        padding: 0.2em 0.4em;
        border-radius: 3px;
        font-family: 'Fira Code', monospace;
    }
    .challenge-content blockquote {
        border-left: 4px solid #6c757d;
        padding-left: 1rem;
        margin: 1.5rem 0;
        color: #6c757d;
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-4 challenge-container">
    <div class="row g-4">
        <div class="col-lg-8">
            <div class="card shadow">
                <div class="card-header bg-dark">
                    <div class="d-flex justify-content-between align-items-center">
                        <h3 class="mb-0 text-light">
                            <i class="fas fa-flag me-2"></i>{{ challenge.name }}
                        </h3>
                        {% if progress and progress.completed %}
                            <span class="badge bg-success fs-6">
                                <i class="fas fa-check-circle"></i> Completed
                            </span>
                        {% endif %}
                    </div>
                </div>
                <div class="card-body">
                    <div class="mb-4">
                        <span class="badge bg-secondary me-2">
                            <i class="fas fa-tag me-1"></i> {{ challenge.category }}
                        </span>
                        <span class="badge bg-{% if challenge.difficulty == 'Easy' %}success{% elif challenge.difficulty == 'Medium' %}warning{% else %}danger{% endif %} me-2">
                            <i class="fas fa-{{ 'check-circle' if challenge.difficulty == 'Easy' else 'exclamation-circle' if challenge.difficulty == 'Medium' else 'exclamation-triangle' }} me-1"></i>
                            {{ challenge.difficulty }}
                        </span>
                        <span class="badge bg-primary">
                            <i class="fas fa-star me-1"></i> {{ challenge.points }} points
                        </span>
                </div>
                
                    <div class="challenge-description mt-4">
                        <h4 class="text-light mb-3">
                            <i class="fas fa-info-circle me-2"></i>Challenge Description
                        </h4>
                        <div class="p-3 mb-4 bg-dark rounded-3">
                            {{ challenge.description|markdown|safe }}
                        </div>
                        
                        {% if challenge.how_to_execute %}
                            <div class="card how-to-card border-0 mb-4">
                                <div class="card-header bg-transparent border-0">
                                    <h4 class="mb-0 text-light">
                                        <i class="fas fa-terminal me-2 text-danger"></i>How to Execute
                                    </h4>
                                </div>
                                <div class="card-body">
                                    <div class="how-to-execute">
                                        {% for line in challenge.how_to_execute.split('\n') %}
                                            {% if line.strip() %}
                                                <div class="d-flex align-items-start mb-3">
                                                    <span class="step-badge">Step {{ loop.index }}</span>
                                                    <div class="flex-grow-1 ms-2">
                                                        {{ line|markdown|safe }}
                                                    </div>
                                                </div>
                                            {% endif %}
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                        {% endif %}
                        
                        {% if challenge.real_world_use %}
                            <div class="card real-world-card border-0 mb-4">
                                <div class="card-header bg-transparent border-0">
                                    <h4 class="mb-0 text-light">
                                        <i class="fas fa-globe-americas me-2 text-primary"></i>Real World Application
                                    </h4>
                                </div>
                                <div class="card-body">
                                    <div class="real-world-use">
                                        {{ challenge.real_world_use|markdown|safe }}
                                    </div>
                                </div>
                            </div>
                        {% endif %}
                        
                        {% if challenge.hints %}
                            <div class="alert alert-info mt-4">
                                <h6><i class="fas fa-lightbulb me-2"></i>Hint</h6>
                                <p class="mb-0">{{ challenge.hints }}</p>
                            </div>
                        {% endif %}
                    </div>
                {% endif %}
                
                {% if challenge.target_ip %}
                <div class="alert alert-info">
                    <i class="fas fa-bullseye"></i> 
                    <strong>Target IP:</strong> {{ challenge.target_ip }}
                </div>
                {% endif %}
                
                {% if challenge.hints %}
                <div class="mb-4">
                    <button class="btn btn-outline-warning btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#hints">
                        <i class="fas fa-lightbulb"></i> Show Hints
                    </button>
                    <div class="collapse mt-3" id="hints">
                        <div class="alert alert-warning">
                            <i class="fas fa-lightbulb"></i> 
                            <strong>Hint:</strong> {{ challenge.hints }}
                        </div>
                    </div>
                </div>
                {% endif %}
                
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0">
                            <i class="fas fa-key"></i> Submit Flag
                        </h6>
                    </div>
                    <div class="card-body">
                        {% if progress and progress.completed %}
                            <div class="alert alert-success">
                                <i class="fas fa-trophy"></i> 
                                Challenge completed! You earned {{ challenge.points }} points.
                            </div>
                        {% else %}
                            <form id="flagForm">
                                <div class="input-group">
                                    <input type="text" class="form-control" id="flagInput" 
                                           placeholder="Enter flag here..." required>
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-paper-plane"></i> Submit
                                    </button>
                                </div>
                                <input type="hidden" id="challengeId" value="{{ challenge.id }}">
                            </form>
                            <div id="flagResult" class="mt-3"></div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-4">
        <div class="sticky-top" style="top: 20px;">
            <div class="card mb-4">
                <div class="card-header">
                    <h6 class="mb-0"><i class="fas fa-list-ul me-2"></i>Table of Contents</h6>
                </div>
                <div class="card-body py-2" id="toc">
                    <!-- Table of contents will be generated by JavaScript -->
                </div>
            </div>
            <div class="card">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-info-circle"></i> Challenge Info
                </h6>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <strong>Category:</strong><br>
                    <span class="text-muted">{{ challenge.category }}</span>
                </div>
                
                <div class="mb-3">
                    <strong>Difficulty:</strong><br>
                    <span class="difficulty-{{ challenge.difficulty.lower() }}">
                        {{ challenge.difficulty }}
                    </span>
                </div>
                
                <div class="mb-3">
                    <strong>Points:</strong><br>
                    <span class="text-muted">{{ challenge.points }}</span>
                </div>
                
                {% if challenge.vm_name %}
                <div class="mb-3">
                    <strong>VM:</strong><br>
                    <span class="text-muted">{{ challenge.vm_name }}</span>
                </div>
                {% endif %}
                
                {% if progress %}
                <div class="mb-3">
                    <strong>Attempts:</strong><br>
                    <span class="text-muted">{{ progress.attempts }}</span>
                </div>
                
                {% if progress.completed %}
                <div class="mb-3">
                    <strong>Completed:</strong><br>
                    <span class="text-muted">{{ progress.completed_at.strftime('%Y-%m-%d %H:%M') }}</span>
                </div>
                {% endif %}
                {% endif %}
            </div>
        </div>
        
        <div class="card mt-4">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-tools"></i> Tools & Resources
                </h6>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <button class="btn btn-outline-info btn-sm" onclick="openTerminal()">
                        <i class="fas fa-terminal"></i> Web Terminal
                    </button>
                    <button class="btn btn-outline-success btn-sm" onclick="openNmap()">
                        <i class="fas fa-search"></i> Nmap Scanner
                    </button>
                    <button class="btn btn-outline-warning btn-sm" onclick="openBurp()">
                        <i class="fas fa-bug"></i> Burp Suite
                    </button>
                </div>
                
                <hr>
                
                <h6>Common Commands:</h6>
                <div class="small">
                    <code>nmap -sV {{ challenge.target_ip or 'TARGET_IP' }}</code><br>
                    <code>nikto -h {{ challenge.target_ip or 'TARGET_IP' }}</code><br>
                    <code>dirb http://{{ challenge.target_ip or 'TARGET_IP' }}/</code>
                </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Generate table of contents
function generateTOC() {
    const content = document.getElementById('challenge-content');
    const headings = content.querySelectorAll('h2, h3, h4');
    const toc = document.getElementById('toc');
    
    if (headings.length > 0) {
        let tocHTML = '<ul class="nav flex-column">';
        let currentLevel = 2; // Start with h2
        
        headings.forEach((heading, index) => {
            const level = parseInt(heading.tagName.substring(1));
            const id = `section-${index}`;
            heading.id = id;
            
            if (level > currentLevel) {
                tocHTML += '<ul class="nav flex-column ms-3">';
            } else if (level < currentLevel) {
                tocHTML += '</ul>';
            }
            
            tocHTML += `
                <li class="nav-item">
                    <a class="nav-link py-1" href="#${id}">
                        <i class="fas fa-chevron-right me-2 small"></i>
                        ${heading.textContent}
                    </a>
                </li>
            `;
            
            currentLevel = level;
        });
        
        // Close any remaining open lists
        while (currentLevel > 2) {
            tocHTML += '</ul>';
            currentLevel--;
        }
        
        tocHTML += '</ul>';
        toc.innerHTML = tocHTML;
    } else {
        toc.innerHTML = '<p class="text-muted small mb-0">No sections available</p>';
    }
    
    // Initialize tooltips
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
}

// Run when document is ready
document.addEventListener('DOMContentLoaded', function() {
    generateTOC();
    
    // Add copy buttons to code blocks
    document.querySelectorAll('pre code').forEach((block) => {
        const pre = block.parentNode;
        const wrapper = document.createElement('div');
        wrapper.className = 'position-relative';
        
        // Create copy button
        const button = document.createElement('button');
        button.className = 'btn btn-sm btn-outline-secondary position-absolute top-0 end-0 m-2';
        button.style.zIndex = '1';
        button.innerHTML = '<i class="far fa-copy"></i>';
        button.setAttribute('data-bs-toggle', 'tooltip');
        button.setAttribute('title', 'Copy to clipboard');
        
        button.addEventListener('click', function() {
            navigator.clipboard.writeText(block.textContent).then(() => {
                const originalTitle = button.getAttribute('title');
                button.setAttribute('title', 'Copied!');
                const tooltip = bootstrap.Tooltip.getInstance(button);
                if (tooltip) {
                    tooltip.setContent({'.tooltip-inner': 'Copied!'});
                    tooltip.show();
                }
                
                setTimeout(() => {
                    button.setAttribute('title', originalTitle);
                    if (tooltip) {
                        tooltip.setContent({'.tooltip-inner': originalTitle});
                    }
                }, 2000);
            });
        });
        
        // Wrap the pre tag with our wrapper and add the button
        pre.parentNode.insertBefore(wrapper, pre);
        wrapper.appendChild(pre);
        pre.insertBefore(button, block);
    });
});
</script>

<div class="mt-4">
    <a href="{{ url_for('challenges') }}" class="btn btn-secondary">
        <i class="fas fa-arrow-left"></i> Back to Challenges
    </a>
</div>
{% endblock %}

{% block scripts %}
<script>
document.getElementById('flagForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const flag = document.getElementById('flagInput').value;
    const challengeId = document.getElementById('challengeId').value;
    const resultDiv = document.getElementById('flagResult');
    
    fetch('/submit_flag', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: `flag=${encodeURIComponent(flag)}&challenge_id=${challengeId}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            resultDiv.innerHTML = `
                <div class="alert alert-success">
                    <i class="fas fa-check-circle"></i> ${data.message}
                </div>
            `;
            setTimeout(() => {
                location.reload();
            }, 2000);
        } else {
            resultDiv.innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-times-circle"></i> ${data.message}
                </div>
            `;
        }
    })
    .catch(error => {
        resultDiv.innerHTML = `
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-triangle"></i> Error submitting flag
            </div>
        `;
    });
});

function openTerminal() {
    alert('Web terminal feature coming soon!');
}

function openNmap() {
    alert('Integrated Nmap scanner coming soon!');
}

function openBurp() {
    alert('Burp Suite integration coming soon!');
}
</script>
{% endblock %}
